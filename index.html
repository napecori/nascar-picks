<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thunder Picks — NASCAR 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Special+Elite&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #0a0a0a; --cream: #f5f0e8; --red: #c8102e; --gold: #d4a017;
    --dark-gold: #a07810; --gray: #2a2a2a; --mid-gray: #444; --light-gray: #888;
    --checkered: repeating-conic-gradient(#0a0a0a 0% 25%, #f5f0e8 0% 50%) 0 0 / 20px 20px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background-color: var(--black); color: var(--cream); font-family: 'Barlow Condensed', sans-serif; min-height: 100vh; }
  .site-header { background: var(--black); border-bottom: 6px solid var(--red); }
  .header-checkered { height: 18px; background: var(--checkered); opacity: 0.6; }
  .header-inner { padding: 24px 40px 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
  .site-title { font-family: 'Bebas Neue', sans-serif; font-size: 4rem; letter-spacing: 4px; color: var(--cream); line-height: 1; text-shadow: 4px 4px 0 var(--red); }
  .site-title span { color: var(--gold); }
  .header-badge { background: var(--red); color: var(--cream); font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; padding: 6px 16px; border: 2px solid var(--gold); text-align: center; line-height: 1.4; }
  .season-label { font-family: 'Oswald', sans-serif; font-size: 0.85rem; color: var(--gold); letter-spacing: 3px; text-transform: uppercase; margin-top: 4px; }

  .sync-bar { background: #111; border-bottom: 1px solid var(--mid-gray); padding: 6px 40px; display: flex; align-items: center; gap: 10px; font-size: 0.8rem; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; flex-shrink: 0; }
  .sync-dot.synced { background: #4caf50; }
  .sync-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
  .sync-dot.error { background: var(--red); }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }
  .sync-text { color: var(--light-gray); }

  .nav-tabs { display: flex; background: var(--gray); border-bottom: 3px solid var(--red); padding: 0 40px; overflow-x: auto; }
  .nav-tab { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 2px; padding: 14px 28px; cursor: pointer; border: none; background: none; color: var(--light-gray); border-bottom: 4px solid transparent; margin-bottom: -3px; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
  .nav-tab:hover { color: var(--cream); }
  .nav-tab.active { color: var(--gold); border-bottom: 4px solid var(--gold); background: var(--black); }

  .main { padding: 32px 40px; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }


  .commish-bar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: var(--gray); border: 1px solid var(--mid-gray); border-left: 4px solid var(--gold); padding: 10px 18px; margin-bottom: 24px; }
  .commish-bar label { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; font-size: 1rem; color: var(--gold); white-space: nowrap; }
  .commish-bar input[type=password] { background: #111; border: 1px solid var(--mid-gray); color: var(--cream); font-family: 'Barlow Condensed', sans-serif; font-size: 0.95rem; padding: 5px 10px; width: 160px; outline: none; }
  .commish-bar input[type=password]:focus { border-color: var(--gold); }
  .commish-btn { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; font-size: 1rem; padding: 6px 18px; background: var(--red); color: var(--cream); border: none; cursor: pointer; white-space: nowrap; }
  .commish-btn:hover { opacity: 0.85; }
  .commish-status { font-size: 0.85rem; color: var(--light-gray); }
  .commish-status.unlocked { color: #4caf50; }


  .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 3px; color: var(--gold); border-left: 5px solid var(--red); padding-left: 12px; margin-bottom: 16px; }
  .table-wrap { overflow-x: auto; margin-bottom: 40px; -webkit-overflow-scrolling: touch; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  thead tr { background: var(--red); font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 1.5px; }
  thead th { padding: 10px 14px; text-align: left; color: var(--cream); white-space: nowrap; }
  thead th.center { text-align: center; }
  tbody tr { border-bottom: 1px solid var(--mid-gray); transition: background 0.15s; }
  tbody tr:hover { background: rgba(212,160,23,0.08); }
  tbody tr:nth-child(even) { background: rgba(255,255,255,0.03); }
  tbody tr:nth-child(even):hover { background: rgba(212,160,23,0.08); }
  tbody td { padding: 9px 14px; color: var(--cream); white-space: nowrap; }
  tbody td.center { text-align: center; }
  tbody td.pts { color: var(--gold); font-weight: 700; font-size: 1.05rem; }
  tbody td.dim { color: var(--light-gray); font-size: 0.85rem; }
  .discipline-badge { display: inline-block; padding: 2px 8px; font-size: 0.75rem; letter-spacing: 1px; font-weight: 700; text-transform: uppercase; border-radius: 2px; }
  .disc-superspeedway { background: #1a3a6e; color: #7ab3ff; }
  .disc-speedway { background: #3a1a00; color: #ffa040; }
  .disc-road { background: #1a3a1a; color: #7aff7a; }
  .disc-short { background: #3a1a3a; color: #ff80ff; }

  .player-tabs { display: flex; border-bottom: 2px solid var(--mid-gray); overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .player-tab { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 2px; padding: 10px 24px; cursor: pointer; background: var(--gray); border: none; color: var(--light-gray); border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; flex-shrink: 0; transition: all 0.15s; }
  .player-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: var(--black); }
  .player-tab:hover:not(.active) { color: var(--cream); }
  .picks-content { display: none; }
  .picks-content.active { display: block; }
  .picks-table thead tr { background: #1a1a1a; }
  .picks-table thead th { border-right: 1px solid var(--mid-gray); }
  .picks-table .group-header { background: var(--red); font-family: 'Bebas Neue', sans-serif; letter-spacing: 1.5px; text-align: center; font-size: 0.9rem; }
  .picks-table .subheader { background: #1c1c1c; font-family: 'Oswald', sans-serif; font-size: 0.75rem; letter-spacing: 1px; color: var(--light-gray); text-transform: uppercase; }
  .edit-cell { background: rgba(255,255,255,0.03); }

  .autocomplete-wrap { position: relative; display: inline-block; width: 100%; }
  .autocomplete-wrap input { background: transparent; border: none; border-bottom: 1px dashed var(--mid-gray); color: var(--cream); font-family: 'Barlow Condensed', sans-serif; font-size: 0.92rem; width: 100%; padding: 2px 4px; outline: none; min-width: 120px; }
  .autocomplete-wrap input:focus { border-bottom-color: var(--gold); background: rgba(212,160,23,0.05); }
  .autocomplete-wrap input[readonly] { color: var(--light-gray); cursor: not-allowed; border-bottom-style: solid; border-bottom-color: #333; }
  .ac-dropdown { position: absolute; top: 100%; left: 0; z-index: 100; background: #1a1a1a; border: 1px solid var(--gold); min-width: 200px; max-height: 180px; overflow-y: auto; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.7); }
  .ac-dropdown.open { display: block; }
  .ac-item { padding: 7px 12px; cursor: pointer; font-size: 0.9rem; color: var(--cream); border-bottom: 1px solid #333; }
  .ac-item:hover, .ac-item.selected { background: var(--red); }
  .ac-item .car-num { color: var(--gold); font-weight: 700; margin-right: 6px; font-size: 0.8rem; }
  .fin-input { background: transparent; border: none; border-bottom: 1px dashed var(--mid-gray); color: var(--cream); font-family: 'Barlow Condensed', sans-serif; font-size: 0.92rem; width: 50px; padding: 2px 4px; outline: none; text-align: center; }
  .fin-input:focus { border-bottom-color: var(--gold); background: rgba(212,160,23,0.05); }
  .fin-input[readonly] { color: var(--light-gray); cursor: not-allowed; border-bottom-style: solid; border-bottom-color: #333; }
  .week-num { color: var(--light-gray); font-size: 0.85rem; text-align: center; }
  .total-row td { background: #1a1a1a !important; font-weight: 700; border-top: 2px solid var(--gold); }

  .points-ref-grid { display: grid; grid-template-columns: 280px 1fr; gap: 32px; }
  .footer-checkered { height: 18px; background: var(--checkered); opacity: 0.4; margin-top: 60px; }

  .loading-state { text-align: center; padding: 60px; font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 3px; color: var(--light-gray); }


  /* THIS WEEK PANEL */
  .this-week-panel { background: var(--gray); border: 2px solid var(--mid-gray); border-top: 5px solid var(--red); padding: 0; margin-bottom: 8px; overflow: hidden; }
  .this-week-header { background: var(--red); padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .this-week-label { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px; color: rgba(255,255,255,0.7); }
  .this-week-track { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 2px; color: var(--cream); line-height: 1; }
  .this-week-meta { font-family: 'Oswald', sans-serif; font-size: 0.85rem; color: rgba(255,255,255,0.75); letter-spacing: 1px; text-align: right; }
  .this-week-picks { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; }
  .this-week-player { padding: 18px 20px; border-right: 1px solid var(--mid-gray); }
  .this-week-player:last-child { border-right: none; }
  .this-week-player-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; border-bottom: 1px solid var(--mid-gray); padding-bottom: 6px; }
  .this-week-driver { font-size: 0.95rem; color: var(--cream); padding: 3px 0; display: flex; align-items: center; gap: 6px; }
  .this-week-driver::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--red); flex-shrink: 0; }
  .this-week-driver.has-result { color: var(--light-gray); }
  .this-week-driver .driver-pts { color: var(--gold); font-weight: 700; margin-left: auto; font-size: 0.85rem; }
  .this-week-empty { color: var(--light-gray); font-style: italic; font-size: 0.9rem; }
  .this-week-total { margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--mid-gray); font-family: 'Bebas Neue', sans-serif; font-size: 1rem; color: var(--gold); letter-spacing: 1px; }
  .no-picks-yet { padding: 20px 24px; color: var(--light-gray); font-style: italic; font-size: 0.95rem; }

  /* LEADERBOARD LIST */
  .leaderboard-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
  .lb-row { display: flex; align-items: center; gap: 0; background: var(--gray); border: 1px solid var(--mid-gray); overflow: hidden; position: relative; }
  .lb-row.lb-1 { border-left: 5px solid var(--gold); }
  .lb-row.lb-2 { border-left: 5px solid #aaa; }
  .lb-row.lb-3 { border-left: 5px solid #cd7f32; }
  .lb-row.lb-4 { border-left: 5px solid var(--mid-gray); }
  .lb-rank { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--mid-gray); width: 56px; text-align: center; flex-shrink: 0; }
  .lb-row.lb-1 .lb-rank { color: var(--gold); }
  .lb-row.lb-2 .lb-rank { color: #aaa; }
  .lb-row.lb-3 .lb-rank { color: #cd7f32; }
  .lb-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 2px; flex: 1; padding: 12px 0; }
  .lb-bar-wrap { flex: 2; padding: 0 20px 0 8px; }
  .lb-bar-bg { background: #1a1a1a; height: 10px; border-radius: 5px; overflow: hidden; }
  .lb-bar-fill { height: 100%; border-radius: 5px; background: var(--red); transition: width 0.6s ease; }
  .lb-row.lb-1 .lb-bar-fill { background: var(--gold); }
  .lb-row.lb-2 .lb-bar-fill { background: #aaa; }
  .lb-row.lb-3 .lb-bar-fill { background: #cd7f32; }
  .lb-pts { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--gold); width: 80px; text-align: right; padding-right: 20px; flex-shrink: 0; }
  .lb-pts-label { font-size: 0.65rem; color: var(--light-gray); letter-spacing: 2px; display: block; text-align: right; margin-top: -4px; }
  .lb-races { font-size: 0.75rem; color: var(--light-gray); width: 80px; text-align: right; padding-right: 20px; flex-shrink: 0; }

  @media (max-width: 700px) {
    .this-week-picks { grid-template-columns: 1fr 1fr; }
    .this-week-player:nth-child(2) { border-right: none; }
    .this-week-player:nth-child(3) { border-top: 1px solid var(--mid-gray); border-right: 1px solid var(--mid-gray); }
    .this-week-player:nth-child(4) { border-top: 1px solid var(--mid-gray); border-right: none; }
    .lb-bar-wrap { display: none; }
    .lb-name { font-size: 1.3rem; }
    .lb-rank { width: 42px; font-size: 1.6rem; }
  }

  /* DRIVER STATS */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; margin-bottom: 32px; }
  .stats-card { background: var(--gray); border: 1px solid var(--mid-gray); border-top: 4px solid var(--red); padding: 0; overflow: hidden; }
  .stats-card-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 3px; color: var(--cream); background: #1a1a1a; padding: 10px 16px; border-bottom: 1px solid var(--mid-gray); display: flex; align-items: center; gap: 8px; }
  .stats-card-title span { color: var(--gold); }
  .stats-row { display: flex; align-items: center; gap: 0; padding: 10px 16px; border-bottom: 1px solid #1f1f1f; }
  .stats-row:last-child { border-bottom: none; }
  .stats-pos { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--light-gray); width: 28px; flex-shrink: 0; }
  .stats-pos.gold { color: var(--gold); }
  .stats-pos.silver { color: #aaa; }
  .stats-pos.bronze { color: #cd7f32; }
  .stats-driver-name { flex: 1; font-size: 0.95rem; color: var(--cream); }
  .stats-bar-wrap { flex: 1; padding: 0 12px; }
  .stats-bar-bg { background: #111; height: 6px; border-radius: 3px; overflow: hidden; }
  .stats-bar-fill { height: 100%; border-radius: 3px; background: var(--red); }
  .stats-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; color: var(--gold); width: 60px; text-align: right; flex-shrink: 0; }
  .stats-val-label { font-size: 0.65rem; color: var(--light-gray); display: block; text-align: right; line-height: 1; margin-top: 1px; }
  .stats-sub { font-size: 0.75rem; color: var(--light-gray); margin-left: 4px; }
  .stats-empty { padding: 20px 16px; color: var(--light-gray); font-style: italic; font-size: 0.9rem; }
  .stats-header-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
  .stats-highlight { background: var(--gray); border: 1px solid var(--mid-gray); border-left: 4px solid var(--gold); padding: 16px 20px; }
  .stats-highlight-label { font-size: 0.7rem; letter-spacing: 3px; color: var(--light-gray); text-transform: uppercase; }
  .stats-highlight-val { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--gold); line-height: 1.1; }
  .stats-highlight-sub { font-size: 0.8rem; color: #bbb; margin-top: 2px; }
  @media (max-width: 700px) {
    .stats-grid { grid-template-columns: 1fr; }
    .stats-header-row { grid-template-columns: 1fr; }
  }
  @media (max-width: 900px) {
    .main { padding: 20px 16px; }
    .header-inner { padding: 16px; flex-direction: column; align-items: flex-start; }
    .site-title { font-size: 2.8rem; }
    .points-ref-grid { grid-template-columns: 1fr; }
    .nav-tabs { padding: 0 8px; }
    .sync-bar { padding: 6px 16px; }
  }
  @media (max-width: 600px) {
    .site-title { font-size: 2rem; letter-spacing: 2px; }
    .header-badge { font-size: 0.85rem; padding: 4px 10px; }
    .header-inner { padding: 12px 14px; gap: 10px; }
    .main { padding: 14px 10px; }
    .section-title { font-size: 1.3rem; }
    .nav-tabs { padding: 0; }
    .nav-tab { padding: 12px 12px; font-size: 0.95rem; }
    .commish-bar { gap: 8px; padding: 10px 12px; }
    .commish-bar input[type=password] { width: 130px; }
    .commish-status { width: 100%; }
    .autocomplete-wrap input { min-width: 90px; font-size: 0.85rem; }
    .fin-input { width: 40px; font-size: 0.85rem; }
    tbody td { font-size: 0.82rem; padding: 7px 8px; }
    thead th { font-size: 0.82rem; padding: 8px 8px; }
    .sync-bar { padding: 6px 10px; font-size: 0.72rem; }
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-checkered"></div>
  <div class="header-inner">
    <div>
      <div class="site-title">&#127937; <span>Thunder</span> Picks</div>
      <div class="season-label">NASCAR Fantasy League &mdash; 2026 Season</div>
    </div>
    <div class="header-badge">35 RACES<br>4 PLAYERS<br>3 PICKS/WEEK</div>
  </div>
</header>

<div class="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span class="sync-text" id="sync-text">Not connected &mdash; go to Weekly Picks tab to set up Google Sheets sync</span>
</div>

<nav class="nav-tabs">
  <button class="nav-tab active" onclick="switchTab('standings',this)">&#127942; Standings</button>
  <button class="nav-tab" onclick="switchTab('picks',this)">&#128203; Weekly Picks</button>
  <button class="nav-tab" onclick="switchTab('schedule',this)">&#128197; Schedule</button>
  <button class="nav-tab" onclick="switchTab('pointsref',this)">&#128202; Points Ref</button>
  <button class="nav-tab" onclick="switchTab('driverstats',this)">&#127941; Driver Stats</button>
</nav>

<main class="main">

  <!-- STANDINGS -->
  <div id="tab-standings" class="tab-content active">
    <div id="standings-loading" class="loading-state">Loading...</div>
    <div id="standings-inner" style="display:none">

      <!-- THIS WEEK PANEL -->
      <div id="this-week-panel" class="this-week-panel"></div>

      <!-- LEADERBOARD -->
      <div class="section-title" style="margin-top:32px;">Season Leaderboard</div>
      <div id="leaderboard-list" class="leaderboard-list"></div>

      <!-- FULL RESULTS -->
      <div class="section-title" style="margin-top:36px;">Full Season Results</div>
      <div class="table-wrap">
        <table id="standings-full-table">
          <thead>
            <tr>
              <th>#</th><th>Track</th><th>Discipline</th>
              <th class="center" colspan="3">Alex</th>
              <th class="center" colspan="3">Nick</th>
              <th class="center" colspan="3">Greg Sr</th>
              <th class="center" colspan="3">Greg Jr</th>
            </tr>
            <tr style="background:#1c1c1c;font-family:'Oswald',sans-serif;font-size:0.75rem;color:#888;">
              <th></th><th></th><th></th>
              <th class="center">Picks</th><th class="center">Pts</th><th class="center">Cumul.</th>
              <th class="center">Picks</th><th class="center">Pts</th><th class="center">Cumul.</th>
              <th class="center">Picks</th><th class="center">Pts</th><th class="center">Cumul.</th>
              <th class="center">Picks</th><th class="center">Pts</th><th class="center">Cumul.</th>
            </tr>
          </thead>
          <tbody id="standings-full-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PICKS -->
  <div id="tab-picks" class="tab-content">
    <div class="commish-bar">
      <label>&#128273; Commissioner</label>
      <input type="password" id="commish-pw" placeholder="Password" onkeydown="if(event.key==='Enter')commishLogin()">
      <button class="commish-btn" onclick="commishLogin()">Unlock</button>
      <button class="commish-btn" onclick="commishLogout()" style="background:#333;display:none" id="logout-btn">Lock</button>
      <span class="commish-status" id="commish-status">&#128274; Locked &mdash; view only</span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="commish-btn" onclick="syncRaceResults()" style="background:#1a3a5c;" title="Auto-fill finish positions from the Race Results tab in Google Sheets">&#127937; Sync Race Results</button>
        <button class="commish-btn" onclick="syncFromSheet()" style="background:#1a4a1a;" title="Pull latest data from the Weekly Upload tab in Google Sheets">&#8635; Sync Picks</button>
        <span id="sync-upload-status" style="font-size:0.8rem;color:var(--light-gray);max-width:300px;"></span>
      </div>
    </div>

    <div class="player-tabs" id="player-tabs"></div>
    <div id="picks-panels"></div>
  </div>

  <!-- SCHEDULE -->
  <div id="tab-schedule" class="tab-content">
    <div class="section-title">2026 Race Schedule</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Track</th><th>Discipline</th><th>Date</th><th>Time</th><th>TV</th><th>Radio</th></tr></thead>
        <tbody id="schedule-body"></tbody>
      </table>
    </div>
  </div>

  <!-- POINTS REF -->
  <div id="tab-pointsref" class="tab-content">
    <div class="points-ref-grid">
      <div>
        <div class="section-title">Points Table</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Finish</th><th class="center">Points</th></tr></thead>
            <tbody id="points-ref-body"></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="section-title">How It Works</div>
        <div style="font-family:'Special Elite',serif;color:#bbb;line-height:1.9;font-size:1rem;background:var(--gray);padding:24px;border-left:4px solid var(--gold);max-width:480px;">
          <p>Each week, every player picks <strong style="color:var(--gold);">3 drivers</strong> before the race.</p><br>
          <p>After the race, each driver's finish maps to points using the table.</p><br>
          <p>A player's <strong style="color:var(--gold);">weekly score</strong> is the sum of all three drivers' points.</p><br>
          <p><strong style="color:var(--gold);">Cumulative points</strong> track the running total across all 35 races.</p><br>
          <p>Most points after <strong style="color:var(--gold);">Race 35</strong> wins the season.</p>
        </div>
        <div style="margin-top:24px;">
          <div class="section-title">Discipline Key</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <div><span class="discipline-badge disc-superspeedway">Superspeedway</span> <span style="color:#888;font-size:0.85rem;margin-left:8px;">Daytona, Talladega, Atlanta</span></div>
            <div><span class="discipline-badge disc-speedway">Speedway</span> <span style="color:#888;font-size:0.85rem;margin-left:8px;">Charlotte, Michigan, etc.</span></div>
            <div><span class="discipline-badge disc-road">Road Course</span> <span style="color:#888;font-size:0.85rem;margin-left:8px;">COTA, Sonoma, Watkins Glen</span></div>
            <div><span class="discipline-badge disc-short">Short Track</span> <span style="color:#888;font-size:0.85rem;margin-left:8px;">Bristol, Martinsville, Richmond</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- DRIVER STATS -->
  <div id="tab-driverstats" class="tab-content">
    <div id="driverstats-inner"></div>
  </div>

</main>
<div class="footer-checkered"></div>

<script>
const COMMISH_PASSWORD = 'JJ48';
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzRrOw4atRLSkhRnMvbCGKOS131Y1cW7xjFrysu3HVxR0-RnA8pHw2mcILq-_T-btoc/exec';

const POINTS_TABLE = {
  1:40,2:35,3:34,4:33,5:32,6:31,7:30,8:29,9:28,10:27,
  11:26,12:25,13:24,14:23,15:22,16:21,17:20,18:19,19:18,20:17,
  21:16,22:15,23:14,24:13,25:12,26:11,27:10,28:9,29:8,30:7,
  31:6,32:5,33:4,34:3,35:2,36:1,37:1,38:1,39:1,40:1
};

const PLAYER_NAMES = ['Alex','Nick','Greg Sr','Greg Jr'];

const DRIVERS = [
  {num:'1',name:'Ross Chastain'},{num:'2',name:'Austin Cindric'},{num:'3',name:'Austin Dillon'},
  {num:'4',name:'Noah Gragson'},{num:'5',name:'Kyle Larson'},{num:'6',name:'Brad Keselowski'},
  {num:'7',name:'Daniel Suarez'},{num:'8',name:'Kyle Busch'},{num:'9',name:'Chase Elliott'},
  {num:'10',name:'Ty Dillon'},{num:'11',name:'Denny Hamlin'},{num:'12',name:'Ryan Blaney'},
  {num:'16',name:'AJ Allmendinger'},{num:'17',name:'Chris Buescher'},{num:'19',name:'Chase Briscoe'},
  {num:'20',name:'Christopher Bell'},{num:'21',name:'Josh Berry'},{num:'22',name:'Joey Logano'},
  {num:'23',name:'Bubba Wallace'},{num:'24',name:'William Byron'},{num:'34',name:'Todd Gilliland'},
  {num:'35',name:'Riley Herbst'},{num:'41',name:'Cole Custer'},{num:'42',name:'John Hunter Nemechek'},
  {num:'43',name:'Erik Jones'},{num:'45',name:'Tyler Reddick'},{num:'47',name:'Ricky Stenhouse Jr'},
  {num:'48',name:'Alex Bowman'},{num:'51',name:'Cody Ware'},{num:'54',name:'Ty Gibbs'},
  {num:'71',name:'Zane Smith'},{num:'77',name:'Carson Hocevar'},{num:'88',name:'Connor Zilisch'},
  {num:'97',name:'Shane van Gisbergen'},{num:'99',name:'Daniel Hemric'},
];

const SCHEDULE = [
  {race:1,  track:'EchoPark Speedway (Atlanta)',       disc:'superspeedway', date:'Sun. Feb 22', time:'3:00pm ET',  tv:'FOX',   radio:'PRN'},
  {race:2,  track:'Circuit of the Americas',           disc:'road',          date:'Sun. Mar 1',  time:'3:30pm ET',  tv:'FOX',   radio:'PRN'},
  {race:3,  track:'Phoenix Raceway',                   disc:'short',         date:'Sun. Mar 8',  time:'3:30pm ET',  tv:'FS1',   radio:'MRN'},
  {race:4,  track:'Las Vegas Motor Speedway',          disc:'speedway',      date:'Sun. Mar 15', time:'4:00pm ET',  tv:'FS1',   radio:'PRN'},
  {race:5,  track:'Darlington Raceway',                disc:'speedway',      date:'Sun. Mar 22', time:'3:00pm ET',  tv:'FOX',   radio:'PRN'},
  {race:6,  track:'Martinsville Speedway',             disc:'short',         date:'Sun. Mar 29', time:'3:30pm ET',  tv:'FS1',   radio:'MRN'},
  {race:7,  track:'Bristol Motor Speedway',            disc:'short',         date:'Sun. Apr 12', time:'3:00pm ET',  tv:'FS1',   radio:'PRN'},
  {race:8,  track:'Kansas Speedway',                   disc:'speedway',      date:'Sun. Apr 19', time:'2:00pm ET',  tv:'FOX',   radio:'MRN'},
  {race:9,  track:'Talladega Superspeedway',           disc:'superspeedway', date:'Sun. Apr 26', time:'3:00pm ET',  tv:'FOX',   radio:'PRN'},
  {race:10, track:'Texas Motor Speedway',              disc:'speedway',      date:'Sun. May 3',  time:'3:30pm ET',  tv:'FS1',   radio:'PRN'},
  {race:11, track:'Watkins Glen International',        disc:'road',          date:'Sun. May 10', time:'3:00pm ET',  tv:'FS1',   radio:'MRN'},
  {race:12, track:'Charlotte Motor Speedway',          disc:'speedway',      date:'Sun. May 24', time:'6:00pm ET',  tv:'Prime', radio:'PRN'},
  {race:13, track:'Nashville Superspeedway',           disc:'speedway',      date:'Sun. May 31', time:'7:00pm ET',  tv:'Prime', radio:'PRN'},
  {race:14, track:'Michigan International Speedway',   disc:'speedway',      date:'Sun. Jun 7',  time:'3:00pm ET',  tv:'Prime', radio:'MRN'},
  {race:15, track:'Pocono Raceway',                    disc:'speedway',      date:'Sun. Jun 14', time:'3:00pm ET',  tv:'Prime', radio:'PRN'},
  {race:16, track:'Naval Base Coronado',               disc:'road',          date:'Sun. Jun 21', time:'4:00pm ET',  tv:'Prime', radio:'PRN'},
  {race:17, track:'Sonoma Raceway',                    disc:'road',          date:'Sun. Jun 28', time:'3:30pm ET',  tv:'Prime', radio:'PRN'},
  {race:18, track:'Chicagoland Speedway',              disc:'speedway',      date:'Sun. Jul 5',  time:'6:00pm ET',  tv:'USA',   radio:'MRN'},
  {race:19, track:'EchoPark Speedway (Atlanta)',       disc:'superspeedway', date:'Sun. Jul 12', time:'7:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:20, track:'North Wilkesboro Speedway',         disc:'short',         date:'Sun. Jul 19', time:'7:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:21, track:'Indianapolis Motor Speedway',       disc:'speedway',      date:'Sun. Jul 26', time:'2:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:22, track:'Iowa Speedway',                     disc:'short',         date:'Sun. Aug 9',  time:'3:30pm ET',  tv:'USA',   radio:'MRN'},
  {race:23, track:'Richmond Raceway',                  disc:'short',         date:'Sat. Aug 15', time:'7:00pm ET',  tv:'USA',   radio:'MRN'},
  {race:24, track:'New Hampshire Motor Speedway',      disc:'short',         date:'Sun. Aug 23', time:'3:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:25, track:'Daytona International Speedway',    disc:'superspeedway', date:'Sat. Aug 29', time:'7:30pm ET',  tv:'NBC',   radio:'PRN'},
  {race:26, track:'Darlington Raceway',                disc:'speedway',      date:'Sun. Sep 6',  time:'5:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:27, track:'World Wide Technology Raceway',     disc:'short',         date:'Sun. Sep 13', time:'3:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:28, track:'Bristol Motor Speedway',            disc:'short',         date:'Sat. Sep 19', time:'7:30pm ET',  tv:'USA',   radio:'PRN'},
  {race:29, track:'Kansas Speedway',                   disc:'speedway',      date:'Sun. Sep 27', time:'3:00pm ET',  tv:'USA',   radio:'PRN'},
  {race:30, track:'Las Vegas Motor Speedway',          disc:'speedway',      date:'Sun. Oct 4',  time:'5:30pm ET',  tv:'NBC',   radio:'PRN'},
  {race:31, track:'Charlotte Motor Speedway',          disc:'speedway',      date:'Sun. Oct 11', time:'3:00pm ET',  tv:'NBC',   radio:'PRN'},
  {race:32, track:'Phoenix Raceway',                   disc:'short',         date:'Sun. Oct 18', time:'3:00pm ET',  tv:'NBC',   radio:'MRN'},
  {race:33, track:'Talladega Superspeedway',           disc:'superspeedway', date:'Sun. Oct 25', time:'2:00pm ET',  tv:'NBC',   radio:'PRN'},
  {race:34, track:'Martinsville Speedway',             disc:'short',         date:'Sun. Nov 1',  time:'2:00pm ET',  tv:'NBC',   radio:'PRN'},
  {race:35, track:'Homestead-Miami Speedway',          disc:'speedway',      date:'Sun. Nov 8',  time:'3:00pm ET',  tv:'NBC',   radio:'PRN'},
];

const DISC_LABELS = {superspeedway:'Superspeedway',speedway:'Speedway',road:'Road Course',short:'Short Track'};
const DISC_CLASS  = {superspeedway:'disc-superspeedway',speedway:'disc-speedway',road:'disc-road',short:'disc-short'};

let picks = emptyPicks();
let commishUnlocked = false;
let scriptUrl = SCRIPT_URL;
let saveTimeout = null;

function emptyPicks() {
  return Array.from({length:4}, () =>
    Array.from({length:35}, () => ({d1name:'',d1fin:'',d2name:'',d2fin:'',d3name:'',d3fin:''}))
  );
}

function setSyncStatus(state, msg) {
  document.getElementById('sync-dot').className = 'sync-dot ' + state;
  document.getElementById('sync-text').textContent = msg;
}

async function loadFromSheets() {
  if (!scriptUrl) {
    showStandings();
    return;
  }
  setSyncStatus('syncing', 'Loading data from Google Sheets...');
  try {
    const resp = await fetch(scriptUrl + '?action=load&t=' + Date.now());
    const data = await resp.json();
    if (data.picks) picks = data.picks;
    setSyncStatus('synced', 'Synced with Google Sheets — ' + new Date().toLocaleTimeString());
  } catch(e) {
    setSyncStatus('error', 'Could not connect to Google Sheets — check script URL in Weekly Picks tab');
  }
  showStandings();
}

function showStandings() {
  document.getElementById('standings-loading').style.display = 'none';
  document.getElementById('standings-inner').style.display = 'block';
  renderStandings();
}

async function saveToSheets() {
  if (!scriptUrl) return;
  setSyncStatus("syncing", "Saving...");
  try {
    const formData = new FormData();
    formData.append("action", "save");
    formData.append("data", JSON.stringify({picks}));
    await fetch(scriptUrl, {method: "POST", body: formData, mode: "no-cors"});
    setSyncStatus("synced", "Saved to Google Sheets at " + new Date().toLocaleTimeString());
  } catch(e) {
    setSyncStatus("error", "Save failed — check internet connection");
  }
}

function scheduleSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveToSheets, 1500);
}


function commishLogin() {
  if (document.getElementById('commish-pw').value === COMMISH_PASSWORD) {
    commishUnlocked = true;
    document.getElementById('commish-status').textContent = 'Unlocked — editing enabled';
    document.getElementById('commish-status').className = 'commish-status unlocked';
    document.getElementById('logout-btn').style.display = '';
    document.getElementById('commish-pw').value = '';
    setInputsReadonly(false);
  } else {
    document.getElementById('commish-status').textContent = 'Wrong password';
    document.getElementById('commish-status').className = 'commish-status';
  }
}
function commishLogout() {
  commishUnlocked = false;
  document.getElementById('commish-status').textContent = 'Locked — view only';
  document.getElementById('commish-status').className = 'commish-status';
  document.getElementById('logout-btn').style.display = 'none';
  setInputsReadonly(true);
}
function setInputsReadonly(ro) {
  document.querySelectorAll('.driver-input, .fin-input').forEach(el => el.readOnly = ro);
}

function finPts(fin) {
  const n = parseInt(fin);
  if (!n || n < 1) return 0;
  return POINTS_TABLE[Math.min(n, 40)] || 1;
}
function weekScore(p, r) {
  const d = picks[p][r];
  return finPts(d.d1fin) + finPts(d.d2fin) + finPts(d.d3fin);
}
function cumulScore(p, upTo) {
  let t = 0;
  for (let r = 0; r <= upTo; r++) t += weekScore(p, r);
  return t;
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'standings') renderStandings();
  if (name === 'driverstats') renderDriverStats();
}

function getCurrentRaceIndex() {
  // Stay on the most recently completed race through Monday (day 1)
  // so everyone can see results before flipping to the next week on Tuesday
  const today = new Date();
  const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, 2=Tue...
  const isMonOrEarlier = dayOfWeek <= 1; // Sun or Mon

  let lastCompleted = -1;
  for (let ri = 0; ri < SCHEDULE.length; ri++) {
    const hasResults = PLAYER_NAMES.some((_, pi) => picks[pi][ri].d1fin);
    if (hasResults) lastCompleted = ri;
  }

  // If it's Sunday or Monday and we have a completed race, stay on it
  if (isMonOrEarlier && lastCompleted >= 0) return lastCompleted;

  // Otherwise show the next upcoming race (first with no results)
  for (let ri = 0; ri < SCHEDULE.length; ri++) {
    const hasResults = PLAYER_NAMES.some((_, pi) => picks[pi][ri].d1fin);
    if (!hasResults) return ri;
  }
  return SCHEDULE.length - 1;
}

function renderThisWeek() {
  const panel = document.getElementById('this-week-panel');
  const ri = getCurrentRaceIndex();
  const race = SCHEDULE[ri];
  const tvColor = {FOX:'#f5a623',FS1:'#f5a623',Prime:'#00a8e0',USA:'#1a6bb5',NBC:'#d4a017'}[race.tv]||'#aaa';

  let playerCols = '';
  PLAYER_NAMES.forEach((name, pi) => {
    const d = picks[pi][ri];
    const drivers = [
      {name: d.d1name, fin: d.d1fin},
      {name: d.d2name, fin: d.d2fin},
      {name: d.d3name, fin: d.d3fin},
    ].filter(x => x.name);

    let driverHtml = '';
    if (drivers.length === 0) {
      driverHtml = '<div class="this-week-empty">No picks yet</div>';
    } else {
      drivers.forEach(drv => {
        const pts = drv.fin ? finPts(drv.fin) : '';
        const ptsHtml = pts ? `<span class="driver-pts">${pts} pts</span>` : '';
        const cls = drv.fin ? 'has-result' : '';
        driverHtml += `<div class="this-week-driver ${cls}">${drv.name}${ptsHtml}</div>`;
      });
    }

    const weekPts = weekScore(pi, ri);
    const totalPts = cumulScore(pi, ri);
    const totalHtml = weekPts ? `<div class="this-week-total">Week: ${weekPts} pts &nbsp;|&nbsp; Total: ${totalPts} pts</div>` : '';

    playerCols += `<div class="this-week-player">
      <div class="this-week-player-name">${name}</div>
      ${driverHtml}
      ${totalHtml}
    </div>`;
  });

  panel.innerHTML = `
    <div class="this-week-header">
      <div>
        <div class="this-week-label">Race ${race.race} of 35 &mdash; This Weekend</div>
        <div class="this-week-track">${race.track}</div>
      </div>
      <div class="this-week-meta">
        ${race.date} &bull; ${race.time}<br>
        <span style="color:${tvColor};font-weight:700;">${race.tv}</span> &bull; ${race.radio}
        &nbsp;<span class="discipline-badge ${DISC_CLASS[race.disc]}">${DISC_LABELS[race.disc]}</span>
      </div>
    </div>
    <div class="this-week-picks">${playerCols}</div>`;
}

function renderLeaderboard() {
  const sorted = PLAYER_NAMES.map((n,i) => ({name:n, total:cumulScore(i,34), idx:i, scored: picks[i].filter(r => r.d1fin||r.d2fin||r.d3fin).length}))
    .sort((a,b) => b.total - a.total);
  const maxPts = sorted[0].total || 1;
  const listEl = document.getElementById('leaderboard-list');
  listEl.innerHTML = '';
  sorted.forEach((p, i) => {
    const rank = i + 1;
    const pct = maxPts > 0 ? Math.round((p.total / maxPts) * 100) : 0;
    listEl.innerHTML += `<div class="lb-row lb-${rank}">
      <div class="lb-rank">#${rank}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-bar-wrap">
        <div class="lb-bar-bg"><div class="lb-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div>
        <div class="lb-pts">${p.total}<span class="lb-pts-label">PTS</span></div>
      </div>
      <div class="lb-races">${p.scored} races</div>
    </div>`;
  });
}

function renderStandings() {
  renderThisWeek();
  renderLeaderboard();
  const tbody = document.getElementById('standings-full-body');
  tbody.innerHTML = '';
  SCHEDULE.forEach((race, ri) => {
    const tr = document.createElement('tr');
    let cells = '';
    PLAYER_NAMES.forEach((_, pi) => {
      const d = picks[pi][ri];
      const str = [d.d1name, d.d2name, d.d3name].filter(Boolean).join(', ') || '—';
      cells += `<td class="center dim">${str}</td><td class="center pts">${weekScore(pi,ri)||'—'}</td><td class="center" style="color:#ccc">${cumulScore(pi,ri)||'—'}</td>`;
    });
    tr.innerHTML = `<td class="week-num">${race.race}</td><td>${race.track}</td>
      <td><span class="discipline-badge ${DISC_CLASS[race.disc]}">${DISC_LABELS[race.disc]}</span></td>${cells}`;
    tbody.appendChild(tr);
  });
}

function makeAutocomplete(pi, ri, slot) {
  const wrap = document.createElement('div');
  wrap.className = 'autocomplete-wrap';
  const input = document.createElement('input');
  input.type = 'text'; input.className = 'driver-input';
  input.value = picks[pi][ri][slot+'name'] || '';
  input.placeholder = 'Driver...'; input.readOnly = !commishUnlocked; input.autocomplete = 'off';
  const dropdown = document.createElement('div');
  dropdown.className = 'ac-dropdown';
  let sel = -1;

  function populate(q) {
    dropdown.innerHTML = ''; sel = -1;
    const m = DRIVERS.filter(d => d.name.toLowerCase().includes(q.toLowerCase()) || d.num.includes(q));
    if (!m.length || !q) { dropdown.classList.remove('open'); return; }
    m.forEach(d => {
      const item = document.createElement('div'); item.className = 'ac-item';
      item.innerHTML = `<span class="car-num">#${d.num}</span>${d.name}`;
      item.onmousedown = () => {
        input.value = d.name; picks[pi][ri][slot+'name'] = d.name;
        dropdown.classList.remove('open'); refreshRow(pi, ri); scheduleSave();
      };
      dropdown.appendChild(item);
    });
    dropdown.classList.add('open');
  }
  input.addEventListener('input', () => populate(input.value));
  input.addEventListener('focus', () => { if (input.value) populate(input.value); });
  input.addEventListener('blur', () => { setTimeout(() => dropdown.classList.remove('open'), 150); picks[pi][ri][slot+'name'] = input.value; });
  input.addEventListener('keydown', e => {
    const items = dropdown.querySelectorAll('.ac-item');
    if (e.key==='ArrowDown') { sel=Math.min(sel+1,items.length-1); items.forEach((it,i)=>it.classList.toggle('selected',i===sel)); e.preventDefault(); }
    if (e.key==='ArrowUp')   { sel=Math.max(sel-1,0); items.forEach((it,i)=>it.classList.toggle('selected',i===sel)); e.preventDefault(); }
    if (e.key==='Enter' && sel>=0) items[sel].onmousedown();
    if (e.key==='Escape') dropdown.classList.remove('open');
  });
  wrap.appendChild(input); wrap.appendChild(dropdown);
  return wrap;
}

function makeFinInput(pi, ri, slot) {
  const input = document.createElement('input');
  input.type = 'number'; input.className = 'fin-input';
  input.min = 1; input.max = 43;
  input.value = picks[pi][ri][slot+'fin'] || '';
  input.placeholder = 'Pos'; input.readOnly = !commishUnlocked;
  input.addEventListener('change', () => {
    picks[pi][ri][slot+'fin'] = input.value;
    refreshRow(pi, ri);
    for (let r = ri; r < 35; r++) {
      const w = document.getElementById(`p${pi}r${r}wk`);
      const c = document.getElementById(`p${pi}r${r}cu`);
      if (w) w.textContent = weekScore(pi,r) || '';
      if (c) c.textContent = cumulScore(pi,r) || '';
    }
    scheduleSave();
  });
  return input;
}

function refreshRow(pi, ri) {
  ['d1','d2','d3'].forEach(dx => {
    const el = document.getElementById(`p${pi}r${ri}${dx}pts`);
    if (el) el.textContent = picks[pi][ri][dx+'fin'] ? finPts(picks[pi][ri][dx+'fin']) : '';
  });
  const w = document.getElementById(`p${pi}r${ri}wk`);
  const c = document.getElementById(`p${pi}r${ri}cu`);
  if (w) w.textContent = weekScore(pi,ri) || '';
  if (c) c.textContent = cumulScore(pi,ri) || '';
}

function renderPicksPanels() {
  const tabsEl = document.getElementById('player-tabs');
  const panelsEl = document.getElementById('picks-panels');
  PLAYER_NAMES.forEach((name, pi) => {
    const btn = document.createElement('button');
    btn.className = 'player-tab' + (pi===0?' active':'');
    btn.textContent = name;
    btn.onclick = () => {
      document.querySelectorAll('.player-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.picks-content').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('picks-panel-'+pi).classList.add('active');
    };
    tabsEl.appendChild(btn);

    const panel = document.createElement('div');
    panel.className = 'picks-content'+(pi===0?' active':'');
    panel.id = 'picks-panel-'+pi;
    const wrap = document.createElement('div');
    wrap.className = 'table-wrap';
    const table = document.createElement('table');
    table.className = 'picks-table'; table.style.minWidth = '860px';
    table.innerHTML = `<thead>
      <tr>
        <th rowspan="2" class="center">#</th><th rowspan="2">Track</th><th rowspan="2">Type</th>
        <th colspan="3" class="group-header center">Driver 1</th>
        <th colspan="3" class="group-header center">Driver 2</th>
        <th colspan="3" class="group-header center">Driver 3</th>
        <th rowspan="2" class="center" style="background:var(--dark-gold);color:var(--cream)">Week Pts</th>
        <th rowspan="2" class="center" style="background:#1a1a1a">Cumul.</th>
      </tr>
      <tr class="subheader">
        <th>Driver</th><th class="center">Fin</th><th class="center">Pts</th>
        <th>Driver</th><th class="center">Fin</th><th class="center">Pts</th>
        <th>Driver</th><th class="center">Fin</th><th class="center">Pts</th>
      </tr></thead>`;
    const tbody = document.createElement('tbody');
    SCHEDULE.forEach((race, ri) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="week-num">${race.race}</td><td style="font-size:0.85rem">${race.track}</td>
        <td><span class="discipline-badge ${DISC_CLASS[race.disc]}">${DISC_LABELS[race.disc].substring(0,5)}</span></td>`;
      ['d1','d2','d3'].forEach(slot => {
        const nTd = document.createElement('td'); nTd.className = 'edit-cell'; nTd.appendChild(makeAutocomplete(pi,ri,slot));
        const fTd = document.createElement('td'); fTd.className = 'edit-cell center'; fTd.appendChild(makeFinInput(pi,ri,slot));
        const pTd = document.createElement('td');
        pTd.id = `p${pi}r${ri}${slot}pts`; pTd.className = 'center pts';
        pTd.textContent = picks[pi][ri][slot+'fin'] ? finPts(picks[pi][ri][slot+'fin']) : '';
        tr.appendChild(nTd); tr.appendChild(fTd); tr.appendChild(pTd);
      });
      const wTd = document.createElement('td'); wTd.id = `p${pi}r${ri}wk`; wTd.className = 'center pts'; wTd.style.color = 'var(--gold)'; wTd.textContent = weekScore(pi,ri)||'';
      const cTd = document.createElement('td'); cTd.id = `p${pi}r${ri}cu`; cTd.className = 'center'; cTd.style.color = '#ccc'; cTd.textContent = cumulScore(pi,ri)||'';
      tr.appendChild(wTd); tr.appendChild(cTd);
      tbody.appendChild(tr);
    });
    const tot = document.createElement('tr'); tot.className = 'total-row';
    tot.innerHTML = `<td colspan="3" style="text-align:right;color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:2px;">SEASON TOTAL</td>
      <td colspan="9"></td><td class="center pts" style="font-size:1.2rem">${cumulScore(pi,34)||'—'}</td><td></td>`;
    tbody.appendChild(tot);
    table.appendChild(tbody); wrap.appendChild(table); panel.appendChild(wrap); panelsEl.appendChild(panel);
  });
}

function renderSchedule() {
  const tbody = document.getElementById('schedule-body');
  SCHEDULE.forEach(race => {
    const tr = document.createElement('tr');
    const tvColor = {FOX:'#f5a623',FS1:'#f5a623',Prime:'#00a8e0',USA:'#1a6bb5',NBC:'#d4a017'}[race.tv]||'#aaa';
    tr.innerHTML = `<td class="week-num">${race.race}</td><td>${race.track}</td>
      <td><span class="discipline-badge ${DISC_CLASS[race.disc]}">${DISC_LABELS[race.disc]}</span></td>
      <td class="dim">${race.date}</td><td class="dim">${race.time}</td>
      <td style="color:${tvColor};font-weight:700;font-size:0.9rem">${race.tv}</td>
      <td class="dim">${race.radio}</td>`;
    tbody.appendChild(tr);
  });
}

function renderPointsRef() {
  const tbody = document.getElementById('points-ref-body');
  const sfx = ['st','nd','rd'];
  for (let p = 1; p <= 40; p++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p}${p<=3?sfx[p-1]:'th'}</td><td class="center pts">${POINTS_TABLE[p]}</td>`;
    tbody.appendChild(tr);
  }
}


// ============================================================
// DRIVER STATS
// ============================================================
function renderDriverStats() {
  const container = document.getElementById('driverstats-inner');
  if (!container) return;

  // Build driver stat maps
  const driverStats = {}; // name -> {totalPts, timespicked, finishes, weeklyWins}

  PLAYER_NAMES.forEach((_, pi) => {
    SCHEDULE.forEach((race, ri) => {
      ['d1','d2','d3'].forEach(slot => {
        const name = picks[pi][ri][slot+'name'];
        const fin  = parseInt(picks[pi][ri][slot+'fin']);
        if (!name) return;
        if (!driverStats[name]) driverStats[name] = {totalPts:0, timesPickedBy:{}, finishes:[], weeklyWins:0};
        const pts = fin ? finPts(fin) : 0;
        driverStats[name].totalPts += pts;
        driverStats[name].timesPickedBy[pi] = (driverStats[name].timesPickedBy[pi]||0)+1;
        if (fin) driverStats[name].finishes.push(fin);
      });
    });
  });

  // Per-player driver breakdown
  const playerDriverStats = PLAYER_NAMES.map((_, pi) => {
    const map = {};
    SCHEDULE.forEach((race, ri) => {
      ['d1','d2','d3'].forEach(slot => {
        const name = picks[pi][ri][slot+'name'];
        const fin = parseInt(picks[pi][ri][slot+'fin']);
        if (!name) return;
        if (!map[name]) map[name] = {pts:0, picks:0, finishes:[]};
        map[name].picks++;
        if (fin) { map[name].pts += finPts(fin); map[name].finishes.push(fin); }
      });
    });
    return map;
  });

  // Summary highlights
  const racesComplete = SCHEDULE.filter((_, ri) => PLAYER_NAMES.some((_, pi) => picks[pi][ri].d1fin)).length;
  const totalDriverEntries = Object.values(driverStats).reduce((s,d) => s + Object.values(d.timesPickedBy).reduce((a,b)=>a+b,0), 0);
  const mostPickedDriver = Object.entries(driverStats).sort((a,b) => {
    const ac = Object.values(a[1].timesPickedBy).reduce((s,v)=>s+v,0);
    const bc = Object.values(b[1].timesPickedBy).reduce((s,v)=>s+v,0);
    return bc - ac;
  })[0];
  const topScoringDriver = Object.entries(driverStats).filter(([,d]) => d.finishes.length > 0).sort((a,b) => b[1].totalPts - a[1].totalPts)[0];

  let highlightHtml = '';
  if (racesComplete === 0) {
    highlightHtml = '<div style="color:var(--light-gray);font-style:italic;padding:8px 0 24px;">Stats will appear once race results are entered.</div>';
  } else {
    highlightHtml = `<div class="stats-header-row">
      <div class="stats-highlight">
        <div class="stats-highlight-label">Races Completed</div>
        <div class="stats-highlight-val">${racesComplete} <span style="font-size:1rem;color:var(--light-gray)">/ 35</span></div>
      </div>
      <div class="stats-highlight">
        <div class="stats-highlight-label">Most Picked Driver</div>
        <div class="stats-highlight-val" style="font-size:1.3rem">${mostPickedDriver ? mostPickedDriver[0] : '—'}</div>
        <div class="stats-highlight-sub">${mostPickedDriver ? Object.values(mostPickedDriver[1].timesPickedBy).reduce((a,b)=>a+b,0) + ' total picks' : ''}</div>
      </div>
      <div class="stats-highlight">
        <div class="stats-highlight-label">Top Scoring Driver</div>
        <div class="stats-highlight-val" style="font-size:1.3rem">${topScoringDriver ? topScoringDriver[0] : '—'}</div>
        <div class="stats-highlight-sub">${topScoringDriver ? topScoringDriver[1].totalPts + ' pts across all players' : ''}</div>
      </div>
      <div class="stats-highlight">
        <div class="stats-highlight-label">Total Driver Picks Made</div>
        <div class="stats-highlight-val">${totalDriverEntries}</div>
      </div>
    </div>`;
  }

  // Build per-player top drivers cards
  function makePlayerCard(pi) {
    const map = playerDriverStats[pi];
    const drivers = Object.entries(map).filter(([,d]) => d.picks > 0)
      .sort((a,b) => b[1].pts - a[1].pts).slice(0, 8);
    const maxPts = drivers[0] ? drivers[0][1].pts : 1;

    if (drivers.length === 0) return `<div class="stats-empty">No picks entered yet.</div>`;

    return drivers.map(([name, d], i) => {
      const avg = d.finishes.length ? (d.finishes.reduce((a,b)=>a+b,0)/d.finishes.length).toFixed(1) : '—';
      const pct = maxPts > 0 ? Math.round((d.pts/maxPts)*100) : 0;
      const posClass = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      return `<div class="stats-row">
        <div class="stats-pos ${posClass}">${i+1}</div>
        <div class="stats-driver-name">${name}<span class="stats-sub">${d.picks}x picked &bull; avg fin ${avg}</span></div>
        <div class="stats-bar-wrap"><div class="stats-bar-bg"><div class="stats-bar-fill" style="width:${pct}%"></div></div></div>
        <div class="stats-val">${d.pts}<span class="stats-val-label">PTS</span></div>
      </div>`;
    }).join('');
  }

  // Top drivers overall (by total pts across all players)
  function makeOverallCard() {
    const drivers = Object.entries(driverStats)
      .filter(([,d]) => d.finishes.length > 0)
      .sort((a,b) => b[1].totalPts - a[1].totalPts).slice(0, 8);
    if (drivers.length === 0) return `<div class="stats-empty">No results entered yet.</div>`;
    const maxPts = drivers[0][1].totalPts || 1;
    return drivers.map(([name, d], i) => {
      const picks = Object.values(d.timesPickedBy).reduce((a,b)=>a+b,0);
      const avg = d.finishes.length ? (d.finishes.reduce((a,b)=>a+b,0)/d.finishes.length).toFixed(1) : '—';
      const pct = Math.round((d.totalPts/maxPts)*100);
      const posClass = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      return `<div class="stats-row">
        <div class="stats-pos ${posClass}">${i+1}</div>
        <div class="stats-driver-name">${name}<span class="stats-sub">${picks} picks &bull; avg fin ${avg}</span></div>
        <div class="stats-bar-wrap"><div class="stats-bar-bg"><div class="stats-bar-fill" style="width:${pct}%"></div></div></div>
        <div class="stats-val">${d.totalPts}<span class="stats-val-label">PTS</span></div>
      </div>`;
    }).join('');
  }

  // Most picked drivers (popularity)
  function makePopularityCard() {
    const drivers = Object.entries(driverStats)
      .map(([name, d]) => ({name, count: Object.values(d.timesPickedBy).reduce((a,b)=>a+b,0), pickers: Object.keys(d.timesPickedBy).map(i => PLAYER_NAMES[i]).join(', ')}))
      .sort((a,b) => b.count - a.count).slice(0, 8);
    if (drivers.length === 0) return `<div class="stats-empty">No picks entered yet.</div>`;
    const max = drivers[0].count || 1;
    return drivers.map((d, i) => {
      const pct = Math.round((d.count/max)*100);
      const posClass = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      return `<div class="stats-row">
        <div class="stats-pos ${posClass}">${i+1}</div>
        <div class="stats-driver-name">${d.name}<span class="stats-sub">${d.pickers}</span></div>
        <div class="stats-bar-wrap"><div class="stats-bar-bg"><div class="stats-bar-fill" style="width:${pct}%"></div></div></div>
        <div class="stats-val">${d.count}<span class="stats-val-label">PICKS</span></div>
      </div>`;
    }).join('');
  }

  container.innerHTML = `
    ${highlightHtml}
    <div class="stats-grid">
      <div class="stats-card">
        <div class="stats-card-title">&#127941; Top Drivers <span>Overall</span></div>
        ${makeOverallCard()}
      </div>
      <div class="stats-card">
        <div class="stats-card-title">&#128202; Most Picked <span>Drivers</span></div>
        ${makePopularityCard()}
      </div>
      ${PLAYER_NAMES.map((name, pi) => `
      <div class="stats-card">
        <div class="stats-card-title">&#128101; ${name}'s <span>Best Drivers</span></div>
        ${makePlayerCard(pi)}
      </div>`).join('')}
    </div>`;
}



// ============================================================
// SYNC RACE RESULTS FROM SHEET
// ============================================================
async function syncRaceResults() {
  const statusEl = document.getElementById('sync-upload-status');
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '⏳ Syncing...';
  statusEl.textContent = '';
  setSyncStatus('syncing', 'Reading race results from Google Sheets...');
  try {
    const resp = await fetch(SCRIPT_URL + '?action=syncResults&t=' + Date.now());
    const data = await resp.json();
    if (data.success) {
      // Reload picks
      const loadResp = await fetch(SCRIPT_URL + '?action=load&t=' + Date.now());
      const loadData = await loadResp.json();
      if (loadData.picks) picks = loadData.picks;
      // Re-render everything
      document.getElementById('picks-panels').innerHTML = '';
      document.getElementById('player-tabs').innerHTML = '';
      renderPicksPanels();
      renderStandings();
      setSyncStatus('synced', 'Race results synced at ' + new Date().toLocaleTimeString());
      statusEl.style.color = '#4caf50';
      statusEl.textContent = data.message;
      if (data.notFound && data.notFound.length) {
        statusEl.style.color = 'var(--gold)';
      }
    } else {
      setSyncStatus('error', 'Sync failed');
      statusEl.style.color = '#f88';
      statusEl.textContent = data.message || data.error || 'Sync failed';
    }
  } catch(e) {
    setSyncStatus('error', 'Connection error');
    statusEl.style.color = '#f88';
    statusEl.textContent = 'Connection error';
  }
  btn.disabled = false;
  btn.textContent = '🏁 Sync Race Results';
}

// ============================================================
// SYNC FROM WEEKLY UPLOAD SHEET
// ============================================================
async function syncFromSheet() {
  const btn = event.target;
  const statusEl = document.getElementById('sync-upload-status');
  btn.disabled = true;
  btn.textContent = '⏳ Syncing...';
  statusEl.textContent = '';
  setSyncStatus('syncing', 'Syncing from Weekly Upload sheet...');
  try {
    const resp = await fetch(SCRIPT_URL + '?action=syncUpload&t=' + Date.now());
    const data = await resp.json();
    if (data.success) {
      // Reload data from sheets to get the updated picks
      const loadResp = await fetch(SCRIPT_URL + '?action=load&t=' + Date.now());
      const loadData = await loadResp.json();
      if (loadData.picks) picks = loadData.picks;
      // Re-render everything
      document.getElementById('picks-panels').innerHTML = '';
      document.getElementById('player-tabs').innerHTML = '';
      renderPicksPanels();
      renderStandings();
      setSyncStatus('synced', 'Synced at ' + new Date().toLocaleTimeString());
      statusEl.style.color = '#4caf50';
      statusEl.textContent = data.message || ('Updated ' + data.updated + ' entries');
      if (data.errors && data.errors.length) {
        statusEl.style.color = 'var(--gold)';
        statusEl.textContent += ' ⚠ ' + data.errors.join(', ');
      }
    } else {
      setSyncStatus('error', 'Sync failed');
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = data.message || data.error || 'Sync failed';
    }
  } catch(e) {
    setSyncStatus('error', 'Sync failed — check connection');
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = 'Connection error';
  }
  btn.disabled = false;
  btn.textContent = '↻ Sync from Sheet';
}

// INIT
renderSchedule();
renderPointsRef();
renderPicksPanels();
loadFromSheets();
</script>
</body>
</html>
